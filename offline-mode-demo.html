<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhEHR Offline Mode Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #dc143c 0%, #ff8c00 30%, #ffd700 60%, #32cd32 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc143c;
            text-align: center;
            margin-bottom: 30px;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        .feature-card h3 {
            color: #dc143c;
            margin-top: 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .online { background: #e8f5e8; color: #2e7d32; }
        .offline { background: #fff3e0; color: #f57c00; }
        .error { background: #ffebee; color: #c62828; }
        button {
            background: #dc143c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #b71c1c;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .demo-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #dc143c;
            border-radius: 8px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• GhEHR Offline Mode Demo</h1>
        
        <div class="demo-section">
            <h2>üîÑ System Status</h2>
            <div id="network-status" class="status">Checking network status...</div>
            <div id="db-status" class="status">Initializing offline database...</div>
            <div id="sync-status" class="status">Sync manager ready</div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>üì± IndexedDB Storage</h3>
                <p>Local database for offline data storage with automatic syncing.</p>
                <button onclick="testOfflineDB()">Test Database</button>
                <button onclick="clearOfflineDB()">Clear Database</button>
            </div>

            <div class="feature-card">
                <h3>üîÑ Background Sync</h3>
                <p>Automatic synchronization when connectivity returns.</p>
                <button onclick="testSync()">Test Sync</button>
                <button onclick="simulateOffline()">Simulate Offline</button>
            </div>

            <div class="feature-card">
                <h3>‚ö†Ô∏è Conflict Resolution</h3>
                <p>Handle simultaneous edits with smart conflict resolution.</p>
                <button onclick="createConflict()">Create Conflict</button>
                <button onclick="resolveConflicts()">Resolve Conflicts</button>
            </div>

            <div class="feature-card">
                <h3>üì¶ PWA Features</h3>
                <p>Progressive Web App with installation and caching.</p>
                <button onclick="testPWA()">Test PWA</button>
                <button onclick="checkInstallable()">Check Installable</button>
            </div>
        </div>

        <div class="demo-section">
            <h2>üìã Demo Actions</h2>
            <button onclick="createTestPatient()">Create Test Patient</button>
            <button onclick="createTestAppointment()">Create Appointment</button>
            <button onclick="createTestNote()">Add Clinical Note</button>
            <button onclick="viewLocalData()">View Local Data</button>
        </div>

        <div class="demo-section">
            <h2>üìù Activity Log</h2>
            <div id="log" class="log">GhEHR Offline Mode Demo - Ready\n</div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let networkOnline = navigator.onLine;
        let dbInitialized = false;
        let testPatientCount = 0;

        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Update network status
        function updateNetworkStatus() {
            const statusElement = document.getElementById('network-status');
            if (navigator.onLine) {
                statusElement.className = 'status online';
                statusElement.textContent = 'üåê Online - Connected to server';
            } else {
                statusElement.className = 'status offline';
                statusElement.textContent = 'üì¥ Offline - Working locally';
            }
            networkOnline = navigator.onLine;
        }

        // Initialize demo
        function initDemo() {
            updateNetworkStatus();
            
            // Simulate database initialization
            setTimeout(() => {
                document.getElementById('db-status').className = 'status online';
                document.getElementById('db-status').textContent = 'üíæ IndexedDB initialized successfully';
                dbInitialized = true;
                log('‚úÖ Offline database initialized');
            }, 1000);

            log('üöÄ GhEHR Offline Mode Demo started');
        }

        // Test offline database
        function testOfflineDB() {
            if (!dbInitialized) {
                log('‚ùå Database not initialized yet');
                return;
            }

            const testData = {
                id: `test_${Date.now()}`,
                name: 'Test Patient',
                email: 'test@example.com',
                created: new Date().toISOString()
            };

            log('üíæ Saving test data to IndexedDB...');
            log(`üìù Data: ${JSON.stringify(testData, null, 2)}`);
            log('‚úÖ Test data saved successfully (simulated)');
        }

        // Clear offline database
        function clearOfflineDB() {
            log('üóëÔ∏è Clearing offline database...');
            setTimeout(() => {
                log('‚úÖ Offline database cleared successfully (simulated)');
            }, 500);
        }

        // Test sync functionality
        function testSync() {
            if (!networkOnline) {
                log('üì¥ Cannot sync while offline - operations queued');
                return;
            }

            log('üîÑ Starting background sync...');
            log('üì§ Syncing pending operations...');
            
            setTimeout(() => {
                log('‚úÖ Sync completed successfully');
                log('üìä 0 conflicts detected');
            }, 2000);
        }

        // Simulate offline mode
        function simulateOffline() {
            log('üì¥ Simulating offline mode...');
            log('‚ö†Ô∏è Network connectivity lost');
            log('üíæ Switching to offline-first mode');
            log('üîÑ All operations will be queued for sync');
            
            // Update UI to show offline status
            const statusElement = document.getElementById('network-status');
            statusElement.className = 'status offline';
            statusElement.textContent = 'üì¥ Simulated Offline Mode';
            
            setTimeout(() => {
                log('üåê Network connectivity restored');
                log('üîÑ Starting automatic sync...');
                updateNetworkStatus();
            }, 5000);
        }

        // Create conflict simulation
        function createConflict() {
            log('‚ö†Ô∏è Creating simulated data conflict...');
            log('üìù Local version: Patient updated locally');
            log('üåê Server version: Patient updated on server');
            log('‚ùå Conflict detected - requires resolution');
            
            const statusElement = document.getElementById('sync-status');
            statusElement.className = 'status error';
            statusElement.textContent = '‚ö†Ô∏è 1 conflict requires resolution';
        }

        // Resolve conflicts
        function resolveConflicts() {
            log('üîß Opening conflict resolution dialog...');
            log('üë§ User selected: Use local version');
            log('‚úÖ Conflict resolved successfully');
            log('üîÑ Resuming normal sync operations');
            
            const statusElement = document.getElementById('sync-status');
            statusElement.className = 'status online';
            statusElement.textContent = '‚úÖ All conflicts resolved';
        }

        // Test PWA features
        function testPWA() {
            log('üì± Testing PWA features...');
            
            if ('serviceWorker' in navigator) {
                log('‚úÖ Service Worker supported');
            } else {
                log('‚ùå Service Worker not supported');
            }
            
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('üì± Running in standalone mode (installed)');
            } else {
                log('üåê Running in browser mode');
            }
            
            log('üì¶ Checking cache status...');
            log('‚úÖ Static files cached');
            log('‚úÖ API responses cached');
        }

        // Check if app is installable
        function checkInstallable() {
            log('üîç Checking PWA installation status...');
            
            if (window.matchMedia('(display-mode: standalone)').matches) {
                log('‚úÖ App is already installed');
            } else {
                log('üì± App can be installed as PWA');
                log('üí° Look for install prompt in address bar');
            }
        }

        // Create test patient
        function createTestPatient() {
            testPatientCount++;
            const patient = {
                id: `patient_${testPatientCount}`,
                name: `Test Patient ${testPatientCount}`,
                email: `patient${testPatientCount}@example.com`,
                phone: `+233${200000000 + testPatientCount}`,
                created: new Date().toISOString()
            };
            
            log(`üë§ Creating test patient: ${patient.name}`);
            log(`üìß Email: ${patient.email}`);
            log('üíæ Saved to local database');
            
            if (networkOnline) {
                log('üîÑ Syncing to server...');
                setTimeout(() => log('‚úÖ Patient synced successfully'), 1000);
            } else {
                log('üì¥ Queued for sync when online');
            }
        }

        // Create test appointment
        function createTestAppointment() {
            const appointment = {
                id: `appt_${Date.now()}`,
                patientId: `patient_${testPatientCount || 1}`,
                date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                time: '10:00 AM',
                type: 'Consultation',
                created: new Date().toISOString()
            };
            
            log(`üìÖ Creating appointment for ${appointment.date}`);
            log(`‚è∞ Time: ${appointment.time}`);
            log('üíæ Saved to local database');
            
            if (networkOnline) {
                log('üìß Sending confirmation email...');
                setTimeout(() => log('‚úÖ Appointment confirmed'), 1000);
            }
        }

        // Create test clinical note
        function createTestNote() {
            const note = {
                id: `note_${Date.now()}`,
                patientId: `patient_${testPatientCount || 1}`,
                content: 'Patient presents with fever and headache. Vitals stable.',
                diagnosis: 'Viral infection - monitoring required',
                created: new Date().toISOString()
            };
            
            log('üìù Creating clinical note...');
            log(`üìã Diagnosis: ${note.diagnosis}`);
            log('ü§ñ Running AI analysis...');
            log('‚úÖ Note saved with AI insights');
        }

        // View local data
        function viewLocalData() {
            log('üìä Local Database Contents:');
            log(`üë• Patients: ${testPatientCount} records`);
            log('üìÖ Appointments: 1 upcoming');
            log('üìù Clinical Notes: 1 recent');
            log('üß™ Lab Orders: 0 pending');
            log('üí∞ Billing: 0 unpaid');
            log('üîÑ Sync Queue: 0 operations pending');
        }

        // Clear log
        function clearLog() {
            document.getElementById('log').textContent = 'Log cleared\n';
        }

        // Event listeners
        window.addEventListener('online', () => {
            updateNetworkStatus();
            log('üåê Network connection restored');
        });

        window.addEventListener('offline', () => {
            updateNetworkStatus();
            log('üì¥ Network connection lost - entering offline mode');
        });

        // Initialize when page loads
        window.addEventListener('load', initDemo);
    </script>
</body>
</html>
